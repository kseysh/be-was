<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="../reset.css" rel="stylesheet"/>
    <link href="../global.css" rel="stylesheet"/>
    <style>
        /* 1. SVG 규격(200x200)에 맞춘 컨테이너 */
        .profile_image {
            width: 200px;        /* SVG width와 동일 */
            height: 200px;       /* SVG height와 동일 */
            border-radius: 50%;  /* 완벽한 원형 */
            overflow: hidden;    /* 영역 밖 이미지 절단 */
            background-color: #D9D9D9; /* SVG의 fill 컬러와 동일하게 기본 배경 설정 */

            /* 중앙 정렬을 위한 설정 (부모 요소 내에서) */
            margin: 0 auto;
        }

        /* 2. 원 안에 이미지를 꽉 채우는 설정 */
        .profile {
            width: 100%;
            height: 100%;

            /* 이미지가 찌그러지지 않게 비율을 유지하며 200x200을 꽉 채움 */
            object-fit: cover;

            /* 이미지의 중심을 기준으로 배치 */
            object-position: center;
        }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <a href="/"><img src="../img/signiture.svg"/></a>
        <ul class="header__menu">
            <li class="header__menu__item">
                안녕하세요,&nbsp;<a href="/mypage" class="btn">{{name}}</a>님! &nbsp;&nbsp;
                <a class="btn btn_contained btn_size_s" href="/article">글쓰기</a>
            </li>
            <li class="header__menu__item">
                <button id="logout-btn" class="btn btn_ghost btn_size_s">
                    <a class="btn" href="/logout">로그아웃</a>
                </button>
            </li>
        </ul>
    </header>
    <div class="page">
        <h2 class="page-title">마이페이지</h2>
        <div class="profile_container">
            <form id="mypage-form" class="profile_box_form">

                <div class="profile_box">
                    <div class="profile_image">
                        <img class="profile" id="profile-preview" src="{{image}}"/>
                    </div>

                    <div class="profile_frame">
                        <div class="btn_profile" onclick="document.getElementById('image-input').click()">
                            <div class="btn_container">수정</div>
                        </div>

                        <input type="file" id="image-input" name="image" accept="image/*" style="display:none"
                               onchange="previewImage(this)">

                        <div class="btn_bar"></div>

                        <div class="btn_profile" onclick="resetImage()">
                            <div class="btn_container">삭제</div>
                        </div>
                    </div>
                </div>

                <div class="form_fields">
                    <div class="textfield textfield_size_s input_margin">
                        <p class="title_textfield">닉네임</p>
                        <input class="input_textfield" name="nickname" value="{{name}}" placeholder="닉네임"/>
                    </div>

                    <div class="textfield textfield_size_s">
                        <p class="title_textfield">비밀번호</p>
                        <input class="input_textfield" type="password" name="password" placeholder="변경할 경우 입력"/>
                    </div>

                    <div class="textfield textfield_size_s">
                        <p class="title_textfield">비밀번호 확인</p>
                        <input class="input_textfield" type="password" name="passwordConfirm" placeholder="한 번 더 입력"/>
                    </div>

                    <button id="registration-btn" class="btn btn_contained btn_size_m input_margin" type="submit">
                        변경사항 저장
                    </button>
                </div>
            </form>
        </div>

    </div>
</div>
<script>
    const DEFAULT_IMAGE = "../img/default-profile.svg";
    const INITIAL_IMAGE = "{{image}}"; // 서버에서 받아온 초기 이미지 경로 저장
    const preview = document.getElementById('profile-preview');
    const fileInput = document.getElementById('image-input');
    let isImageDeleted = false; // 삭제 버튼을 눌렀는지 여부 기록

    // 1. 이미지 미리보기 로직
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                isImageDeleted = false; // 새 파일을 선택하면 삭제 상태 해제
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 2. 이미지 삭제 로직
    function resetImage() {
        preview.src = DEFAULT_IMAGE;
        fileInput.value = ""; // 선택된 파일 초기화
        isImageDeleted = true; // 삭제 상태 활성화
    }

    // 3. 폼 전송 로직
    document.getElementById('mypage-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const password = e.target.password.value;
        const passwordConfirm = e.target.passwordConfirm.value;

        // [추가] 비밀번호 확인 로직
        if (password || passwordConfirm) { // 비밀번호를 입력하려고 한 경우
            if (password !== passwordConfirm) {
                alert("비밀번호가 일치하지 않습니다.");
                return;
            }
        }

        const formData = new FormData(e.target);

        // [개선] 이미지 전송 로직 분기 처리
        if (isImageDeleted) {
            // 삭제 버튼을 눌렀을 때
            formData.set('isDeleteImage', 'true');
            formData.delete('image'); // 빈 파일이 전송되지 않도록 삭제
        } else if (!fileInput.files[0]) {
            // 수정 버튼을 누르지 않았을 때 (기존 이미지 유지)
            // 서버에서 "image 필드가 없으면 기존 데이터 유지"로 처리하도록 필드 제거
            formData.delete('image');
        }

        try {
            const response = await fetch('/mypage', {
                method: 'PATCH',
                body: formData
            });

            if (response.redirected) {
                // 응답이 성공적이면 메인으로 이동
                window.location.href = "/";
            } else {
                const errorData = await response.json();
                alert(errorData.message || "수정 실패!");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("서버 통신 중 오류가 발생했습니다.");
        }
    });
</script>
</body>
</html>
