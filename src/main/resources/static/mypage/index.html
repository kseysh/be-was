<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="../reset.css" rel="stylesheet"/>
    <link href="../global.css" rel="stylesheet"/>
    <style>
        .profile_image {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            overflow: hidden;
            background-color: #D9D9D9;
            margin: 0 auto;
        }

        .profile {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <a href="/"><img src="../img/signiture.svg"/></a>
        <ul class="header__menu">
            <li class="header__menu__item">
                안녕하세요,&nbsp;<a href="/mypage" class="btn">{{name}}</a>님! &nbsp;&nbsp;
                <a class="btn btn_contained btn_size_s" href="/article">글쓰기</a>
            </li>
            <li class="header__menu__item">
                <button id="logout-btn" class="btn btn_ghost btn_size_s">
                    <a class="btn" href="/logout">로그아웃</a>
                </button>
            </li>
        </ul>
    </header>
    <div class="page">
        <h2 class="page-title">마이페이지</h2>
        <div class="profile_container">
            <form id="mypage-form" class="profile_box_form">

                <div class="profile_box">
                    <div class="profile_image">
                        <img class="profile" id="profile-preview" src="{{image}}"/>
                    </div>

                    <div class="profile_frame">
                        <div class="btn_profile" onclick="document.getElementById('image-input').click()">
                            <div class="btn_container">수정</div>
                        </div>

                        <input type="file" id="image-input" name="image" accept="image/*" style="display:none"
                               onchange="previewImage(this)">

                        <div class="btn_bar"></div>

                        <div class="btn_profile" onclick="resetImage()">
                            <div class="btn_container">삭제</div>
                        </div>
                    </div>
                </div>

                <div class="form_fields">
                    <div class="textfield textfield_size_s input_margin">
                        <p class="title_textfield">닉네임</p>
                        <input class="input_textfield" name="nickname" value="{{name}}" placeholder="닉네임" minlength="4"
                               maxlength="20"/>
                    </div>

                    <div class="textfield textfield_size_s">
                        <p class="title_textfield">비밀번호</p>
                        <input class="input_textfield" type="password" name="password" placeholder="변경할 경우 입력"
                               minlength="4" maxlength="20"/>
                    </div>

                    <div class="textfield textfield_size_s">
                        <p class="title_textfield">비밀번호 확인</p>
                        <input class="input_textfield" type="password" name="passwordConfirm" placeholder="한 번 더 입력"/>
                    </div>

                    <button id="registration-btn" class="btn btn_contained btn_size_m input_margin" type="submit">
                        변경사항 저장
                    </button>
                </div>
            </form>
        </div>

    </div>
</div>
<script>
    const DEFAULT_IMAGE = "../img/basic_profileImage.svg";
    const preview = document.getElementById('profile-preview');
    const fileInput = document.getElementById('image-input');
    let isImageDeleted = false;

    // 1. 이미지 미리보기 로직
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                isImageDeleted = false;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 2. 이미지 삭제 로직
    function resetImage() {
        preview.src = DEFAULT_IMAGE;
        fileInput.value = "";
        isImageDeleted = true;
    }

    // 3. 폼 전송 로직
    document.getElementById('mypage-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const password = e.target.password.value;
        const passwordConfirm = e.target.passwordConfirm.value;

        if (password || passwordConfirm) {
            if (password !== passwordConfirm) {
                alert("비밀번호가 일치하지 않습니다.");
                return;
            }
        }

        const formData = new FormData(e.target);

        if (isImageDeleted) {
            try {
                const response = await fetch(DEFAULT_IMAGE);
                const blob = await response.blob();
                const defaultFile = new File([blob], "default-profile.svg", {type: blob.type});
                formData.set('image', defaultFile);

            } catch (err) {
                console.error("기본 이미지 로드 실패:", err);
                alert("기본 이미지 처리 중 오류가 발생했습니다.");
                return;
            }
        } else if (!fileInput.files[0]) {
            formData.delete('image');
        }

        try {
            const response = await fetch('/mypage', {
                method: 'PATCH',
                body: formData
            });

            if (response.redirected) {
                window.location.href = "/";
            } else {
                const errorData = await response.json();
                alert(errorData.message || "수정 실패!");
            }
        } catch (error) {
            console.error("Error:", error);
            window.location.href = "/";
        }
    });
</script>
</body>
</html>